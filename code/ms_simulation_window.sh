#! /bin/bash

# common parameters for ms simulation
sample_size=18   # Sample size for each population
number_samples=$((2*$sample_size))   # Number of copies of the locus in each sample. Set to 36 because of our experimental sample structure of 2 pop x 6 crosses x 2 strain per cross x 150% (because of the ~50% remaining heterozygosity in each strain)
number_reps=100000 # Number of independent replicates. Equivalent to the number of independent SNPs being simulated.
popstr="-I 6 ${sample_size} 0 0 0 0 ${sample_size} 0"  # Population Structure. The used parameters means: 6 populations, sample sizes for each population (here ZI, RG, CO, EA, EG, and FR) being 18, 0, 0, 0, 0, 18, and migration rate = 0.
non_parametric_num_site=5000    # Number of sites within a window. This number is not specified as a parameter in the ms command, but is multiplied to theta

# demographic parameters that vary across chromosomal arms or combinations of populations
demo_models=("chrX_6_pop" "chr2R_5_pop" "chr3L_6_pop")
mutation_params=("-t $(echo "0.006931286816*$non_parametric_num_site" | bc)" \
"-t $(echo "0.007825323409*$non_parametric_num_site" | bc)" \
"-t $(echo "0.007709097286*$non_parametric_num_site" | bc)"
)   # Population-level mutation rate (theta), calculated as per-site mutation rate multiplied by the number of sites. E.g., when number of sites=5000, a random number of mutations are simulated across a segment of 5000 bp. Since recombination does not affect nucpleotide diversity, we don't need to set the recombination parameter '-r'.

other_demo_params=("-en 0 1 3.173337227 -en 0 2 1.744557454 -en 0 3 1.567815653 -en 0 4 1.092572221 -en 0 5 0.104324432 -en 0 6 0.343941249 -em 0 1 2 2.13E+01 -em 0 2 1 2.13E+01 -em 0 1 3 6.20E-04 -em 0 3 1 6.20E-04 -em 0 1 4 0 -em 0 4 1 0 -em 0 1 5 0 -em 0 5 1 0 -em 0 1 6 0 -em 0 6 1 0 -em 0 2 3 1.30E+01 -em 0 3 2 1.30E+01 -em 0 2 4 1.74E+01 -em 0 4 2 1.74E+01 -em 0 2 5 4.18E+00 -em 0 5 2 4.18E+00 -em 0 2 6 0 -em 0 6 2 0 -em 0 3 4 6.90E-02 -em 0 4 3 6.90E-02 -em 0 3 5 2.96E-01 -em 0 5 3 2.96E-01 -em 0 3 6 0 -em 0 6 3 0 -em 0 4 5 5.83E-02 -em 0 5 4 5.83E-02 -em 0 4 6 0 -em 0 6 4 0 -em 0 5 6 3.38E+01 -em 0 6 5 3.38E+01 -ej 0.007661707 6 5 -en 0.007661707001 5 0.054085732 -em 0.007661707001 1 2 2.13E+01 -em 0.007661707001 2 1 2.13E+01 -em 0.007661707001 1 3 6.20E-04 -em 0.007661707001 3 1 6.20E-04 -em 0.007661707001 1 4 0 -em 0.007661707001 4 1 0 -em 0.007661707001 1 5 0 -em 0.007661707001 5 1 0 -em 0.007661707001 2 3 1.30E+01 -em 0.007661707001 3 2 1.30E+01 -em 0.007661707001 2 4 1.74E+01 -em 0.007661707001 4 2 1.74E+01 -em 0.007661707001 2 5 3.36E+00 -em 0.007661707001 5 2 3.36E+00 -em 0.007661707001 3 4 6.90E-02 -em 0.007661707001 4 3 6.90E-02 -em 0.007661707001 3 5 3.37E+00 -em 0.007661707001 5 3 3.37E+00 -em 0.007661707001 4 5 4.00E+00 -em 0.007661707001 5 4 4.00E+00 -ej 0.037301481 4 3 -en 0.037301481001 3 0.077431613 -em 0.037301481001 1 2 2.13E+01 -em 0.037301481001 2 1 2.13E+01 -em 0.037301481001 1 3 4.44E-03 -em 0.037301481001 3 1 4.44E-03 -em 0.037301481001 1 5 0 -em 0.037301481001 5 1 0 -em 0.037301481001 2 3 5.65E-03 -em 0.037301481001 3 2 5.65E-03 -em 0.037301481001 2 5 3.36E+00 -em 0.037301481001 5 2 3.36E+00 -em 0.037301481001 3 5 1.15E-03 -em 0.037301481001 5 3 1.15E-03 -ej 0.051883961 5 3 -en 0.051883961001 3 0.106814972 -em 0.051883961001 1 2 2.13E+01 -em 0.051883961001 2 1 2.13E+01 -em 0.051883961001 1 3 1.14E-01 -em 0.051883961001 3 1 1.14E-01 -em 0.051883961001 2 3 1.59E+00 -em 0.051883961001 3 2 1.59E+00 -ej 0.053704749 3 2 -en 0.053704749001 2 0.600038179 -em 0.053704749001 1 2 4.97E-02 -em 0.053704749001 2 1 4.97E-02 -ej 0.054821003 1 2 -en 0.054821003 2 1.650830153 -en 0.286350238 2 1" \
" -I 5 ${sample_size} 0 0 0 ${sample_size} 0 -en 0 1 1.704878438 -en 0 2 0.327939838 -en 0 3 0.425374997 -en 0 4 0.274598828 -en 0 5 0.129370411 -em 0 1 2 2.84E+01 -em 0 2 1 2.84E+01 -em 0 1 3 1.08E-02 -em 0 3 1 1.08E-02 -em 0 1 4 0 -em 0 4 1 0 -em 0 1 5 0 -em 0 5 1 0 -em 0 2 3 1.99E+01 -em 0 3 2 1.99E+01 -em 0 2 4 1.57E+01 -em 0 4 2 1.57E+01 -em 0 2 5 6.57E+00 -em 0 5 2 6.57E+00 -em 0 3 4 1.16E-02 -em 0 4 3 1.16E-02 -em 0 3 5 1.78E+00 -em 0 5 3 1.78E+00 -em 0 4 5 1.14E+00 -em 0 5 4 1.14E+00 -ej 0.034413976 4 3 -en 0.034413976001 3 0.186840502 -em 0.034413976001 1 2 2.84E+01 -em 0.034413976001 2 1 2.84E+01 -em 0.034413976001 1 3 2.77E-03 -em 0.034413976001 3 1 2.77E-03 -em 0.034413976001 1 5 0 -em 0.034413976001 5 1 0 -em 0.034413976001 2 3 1.55E-02 -em 0.034413976001 3 2 1.55E-02 -em 0.034413976001 2 5 6.57E+00 -em 0.034413976001 5 2 6.57E+00 -em 0.034413976001 3 5 7.13E-02 -em 0.034413976001 5 3 7.13E-02 -ej 0.061759199 5 3 -en 0.061759199001 3 0.533396129 -em 0.061759199001 1 2 2.84E+01 -em 0.061759199001 2 1 2.84E+01 -em 0.061759199001 1 3 8.96E-03 -em 0.061759199001 3 1 8.96E-03 -em 0.061759199001 2 3 1.86E-01 -em 0.061759199001 3 2 1.86E-01 -ej 0.092920134 3 2 -en 0.092920134001 2 0.358345282 -em 0.092920134001 1 2 1.95E-02 -em 0.092920134001 2 1 1.95E-02 -ej 0.096188358 1 2 -en 0.096188358001 2 0.14017137 -en 0.100840635 2 1" \
"-en 0 1 1.380784346 -en 0 2 0.648736538 -en 0 3 0.554391806 -en 0 4 0.239910374 -en 0 5 0.159309414 -en 0 6 0.360784008 -em 0 1 2 1.77E+01 -em 0 2 1 1.77E+01 -em 0 1 3 1.39E-01 -em 0 3 1 1.39E-01 -em 0 1 4 0 -em 0 4 1 0 -em 0 1 5 0 -em 0 5 1 0 -em 0 1 6 0 -em 0 6 1 0 -em 0 2 3 1.59E+01 -em 0 3 2 1.59E+01 -em 0 2 4 1.26E+01 -em 0 4 2 1.26E+01 -em 0 2 5 1.53E+00 -em 0 5 2 1.53E+00 -em 0 2 6 0 -em 0 6 2 0 -em 0 3 4 2.46E+00 -em 0 4 3 2.46E+00 -em 0 3 5 1.56E+01 -em 0 5 3 1.56E+01 -em 0 3 6 0 -em 0 6 3 0 -em 0 4 5 5.28E+00 -em 0 5 4 5.28E+00 -em 0 4 6 0 -em 0 6 4 0 -em 0 5 6 4.86E+01 -em 0 6 5 4.86E+01 -ej 0.007289253 6 5 -en 0.007289253001 5 0.080531448 -em 0.007289253001 1 2 1.77E+01 -em 0.007289253001 2 1 1.77E+01 -em 0.007289253001 1 3 1.39E-01 -em 0.007289253001 3 1 1.39E-01 -em 0.007289253001 1 4 0 -em 0.007289253001 4 1 0 -em 0.007289253001 1 5 0 -em 0.007289253001 5 1 0 -em 0.007289253001 2 3 1.59E+01 -em 0.007289253001 3 2 1.59E+01 -em 0.007289253001 2 4 1.26E+01 -em 0.007289253001 4 2 1.26E+01 -em 0.007289253001 2 5 1.15E+01 -em 0.007289253001 5 2 1.15E+01 -em 0.007289253001 3 4 2.46E+00 -em 0.007289253001 4 3 2.46E+00 -em 0.007289253001 3 5 2.84E-02 -em 0.007289253001 5 3 2.84E-02 -em 0.007289253001 4 5 2.65E-03 -em 0.007289253001 5 4 2.65E-03 -ej 0.04057006 4 3 -en 0.04057006001 3 0.074500944 -em 0.04057006001 1 2 1.77E+01 -em 0.04057006001 2 1 1.77E+01 -em 0.04057006001 1 3 5.65E-02 -em 0.04057006001 3 1 5.65E-02 -em 0.04057006001 1 5 0 -em 0.04057006001 5 1 0 -em 0.04057006001 2 3 1.10E-01 -em 0.04057006001 3 2 1.10E-01 -em 0.04057006001 2 5 1.15E+01 -em 0.04057006001 5 2 1.15E+01 -em 0.04057006001 3 5 4.87E-02 -em 0.04057006001 5 3 4.87E-02 -ej 0.044395565 5 3 -en 0.044395565001 3 0.595799621 -em 0.044395565001 1 2 1.77E+01 -em 0.044395565001 2 1 1.77E+01 -em 0.044395565001 1 3 5.10E-01 -em 0.044395565001 3 1 5.10E-01 -em 0.044395565001 2 3 1.31E+00 -em 0.044395565001 3 2 1.31E+00 -ej 0.045115152 3 2 -en 0.045115152001 2 0.200985601 -em 0.045115152001 1 2 2.42E+00 -em 0.045115152001 2 1 2.42E+00 -ej 0.046117315 1 2 -en 0.046117315001 2 0.18277622 -en 0.047117966 2 1"
)   # demographic parameters including: population size changes (-en), migration rate changes (-em), population mergers (-ej). Also overwrite the previously set population structure for the 5-population model.

# Loop through the demographic models and run ms simulations
for i in "${!demo_models[@]}"; do
    model=${demo_models[$i]}
    mutation_param=${mutation_params[$i]}
    other_demo_param=${other_demo_params[$i]}
    out_log="../data/ms_simulation_${model}.log"
    out_sim="../data/ms_simulation_${model}.txt"
    if ! [ -f $out_sim ]; then
        echo -e "Start running ms simulation for $model at $(date)\n" > $out_log
        SECONDS=0  # Reset the SECONDS counter to start the clock
        # Run the ms command
        ms $number_samples $number_reps $mutation_param $popstr $other_demo_param > $out_sim 2>> $out_log
        # echo "ms $number_samples $number_reps $mutation_param $popstr $other_demo_param > $out_sim 2>> $out_log"
        mv seedms $out_sim.seedms   # Save the seedms file for each simulation
        echo -e "Complete running ms simulation for $model at $(date)\n" >> $out_log
        elapsed_time=$(printf '%02d:%02d:%02d' $(($SECONDS/3600)) $(($SECONDS%3600/60)) $(($SECONDS%60)))
        echo -e "Total time elapsed: $elapsed_time\n" >> $out_log
    fi
done